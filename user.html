<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Investments</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
      color: #333;
    }

    h2 {
      text-align: center;
      background: #2c3e50;
      color: #fff;
      padding: 20px;
      margin: 0;
      font-size: 24px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    #searchBar {
      display: block;
      margin: 20px auto;
      width: 300px;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #adminPanel {
      max-width: 1000px;
      margin: 20px auto;
      padding: 10px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .user-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
      transition: transform 0.2s ease;
    }

    .user-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .user-card h3 {
      margin: 0 0 15px;
      color: #2c3e50;
    }

    .investment-box {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      background: #fafafa;
    }

    .investment-box strong {
      color: #555;
    }

    input[type="number"] {
      width: 100px;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 5px 0;
      font-size: 14px;
    }

    select {
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin: 5px 0;
    }

    button {
      background: #3498db;
      color: #fff;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 5px;
      transition: background 0.3s ease;
      display: none;
    }

    button:hover {
      background: #2980b9;
    }

    input[type="checkbox"] {
      transform: scale(1.2);
      margin-left: 8px;
    }
  </style>
</head>
<body>

  <h2>Admin Panel - Investments</h2>
  <input type="text" id="searchBar" placeholder="Search by Name, Aadhaar, Referral, Plan, Date...">
  <p id="totalUsers" style="text-align:center; font-weight:bold; margin-top:10px;"></p>
  <div id="adminPanel"></div>

<script>
let editedProfits = {};
let allUsers = []; // store all users globally

async function loadInvestments() {
  const res = await fetch('http://localhost:5000/admin/investments');
  const data = await res.json();
  if (data.success) {
    allUsers = data.users; // save users globally
    renderUsers(allUsers);
  }
}

function renderUsers(users) {
  document.getElementById('totalUsers').innerText = `Total Investors: ${users.length}`;
  let html = '';
  users.forEach(user => {
    html += `<div class="user-card"><h3>${user.name} (${user.aadhaar})</h3>
      <p><span class="label">Referral Code:</span> ${user.referralCode}</p>`;

    user.investments.forEach((inv, i) => {
      html += `<div class="investment-box">
        <strong>Plan:</strong> ${inv.plan}<br>
        <strong>Amount:</strong> â‚¹${inv.amount}<br>
        <strong>Invests Date:</strong> ${new Date(inv.date).toLocaleString()}<br>
        <strong>Status:</strong> ${inv.status}<br>
        <strong>Withdrawal Locked:</strong> ${inv.locked ? 'Yes' : 'No'}<br><br>
        
        <label>Profit:</label>
        <input type="number" id="profit_${user.aadhaar}_${i}" value="${inv.profit}" 
               onchange="markProfitEdited('${user.aadhaar}', ${i}, this.value)">
        <button id="approve_${user.aadhaar}_${i}" onclick="approveProfit('${user.aadhaar}', ${i})">Approve</button>
        <br><br>

        <label>Status:</label>
        <select onchange="updateStatus('${user.aadhaar}', ${i}, this.value)">
          <option value="Pending" ${inv.status=='Pending'?'selected':''}>Pending</option>
          <option value="Approved" ${inv.status=='Approved'?'selected':''}>Approved</option>
          <option value="Earning" ${inv.status=='Earning'?'selected':''}>Earning</option>
        </select>
        <br><br>

        <label>Lock Withdrawal:</label>
        <input type="checkbox" ${inv.locked?'checked':''} onchange="updateLock('${user.aadhaar}', ${i}, this.checked)">
      </div>`;
    });
    html += `</div>`;
  });
  document.getElementById('adminPanel').innerHTML = html;
}

// Search function
document.getElementById('searchBar').addEventListener('input', function() {
  const q = this.value.toLowerCase();
  const filtered = allUsers.filter(user => {
    return (
      user.name.toLowerCase().includes(q) ||
      user.aadhaar.toString().includes(q) ||
      user.referralCode.toLowerCase().includes(q) ||
      user.investments.some(inv =>
        inv.plan.toLowerCase().includes(q) ||
        new Date(inv.date).toLocaleString().toLowerCase().includes(q)
      )
    );
  });
  renderUsers(filtered);
});

async function updateStatus(aadhaar, index, status) {
  await fetch('http://localhost:5000/admin/update-investment', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({aadhaar, investmentIndex:index, status})
  });
}

function markProfitEdited(aadhaar, index, value) {
  editedProfits[`${aadhaar}_${index}`] = parseFloat(value);
  const approveBtn = document.getElementById(`approve_${aadhaar}_${index}`);
  if (approveBtn) approveBtn.style.display = 'inline-block';
}

async function approveProfit(aadhaar, index) {
  const key = `${aadhaar}_${index}`;
  if (editedProfits[key] != null) {
    await fetch('http://localhost:5000/admin/update-investment', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({aadhaar, investmentIndex:index, profit:editedProfits[key]})
    });
    const profitInput = document.getElementById(`profit_${aadhaar}_${index}`);
    if (profitInput) profitInput.value = editedProfits[key].toFixed(3);
    delete editedProfits[key];
    const approveBtn = document.getElementById(`approve_${aadhaar}_${index}`);
    if (approveBtn) approveBtn.style.display = 'none';
    alert("Profit updated successfully!");
  }
}

async function updateLock(aadhaar, index, locked) {
  await fetch('http://localhost:5000/admin/update-investment', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({aadhaar, investmentIndex:index, locked})
  });
}

loadInvestments();
</script>
</body>
</html>
